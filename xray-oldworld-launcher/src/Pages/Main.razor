@page "/"
@inject Tauri Tauri
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@implements IDisposable

@if (_loading)
{
    <MudContainer MaxWidth="MaxWidth.Medium" Class="pa-4" Style="background-color: transparent;">
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="200px" Class="mb-4" />
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="150px" />
    </MudContainer>
}
else
{
    <MudContainer MaxWidth="MaxWidth.Medium" Class="pa-4" Style="background-color: transparent;">

        @* ── Launch Configuration ── *@
        <MudText Typo="Typo.h5" Class="mb-3" Style="color: var(--mud-palette-primary);">
            Launch Configuration
        </MudText>

        <div class="pa-4 mb-4">
            <MudGrid Spacing="3">
                <MudItem xs="12" sm="6">
                    <MudSwitch T="bool"
                               Label="Use AVX Executable"
                               Color="Color.Primary"
                               Value="@_config.UseAvx"
                               ValueChanged="@(v => OnConfigChanged(() => _config.UseAvx = v))" />
                    <MudText Typo="Typo.caption" Class="ml-12" Style="color: var(--mud-palette-text-secondary);">
                        Use OldWorldDX11AVX.exe for CPUs with AVX support
                    </MudText>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudSwitch T="bool"
                               Label="Debug Mode"
                               Color="Color.Warning"
                               Value="@_config.DebugMode"
                               ValueChanged="@(v => OnConfigChanged(() => _config.DebugMode = v))" />
                    <MudText Typo="Typo.caption" Class="ml-12" Style="color: var(--mud-palette-text-secondary);">
                        Launch with -dbg flag for debug logging
                    </MudText>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudSelect T="int"
                               Label="Shadow Map Size"
                               Variant="Variant.Outlined"
                               Value="@_config.ShadowMapSize"
                               ValueChanged="@(v => OnConfigChanged(() => _config.ShadowMapSize = v))">
                        <MudSelectItem T="int" Value="1536">1536</MudSelectItem>
                        <MudSelectItem T="int" Value="2048">2048 (Default)</MudSelectItem>
                        <MudSelectItem T="int" Value="2560">2560</MudSelectItem>
                        <MudSelectItem T="int" Value="3072">3072</MudSelectItem>
                        <MudSelectItem T="int" Value="4096">4096</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField T="string"
                                  Label="Custom Launch Arguments"
                                  Variant="Variant.Outlined"
                                  Value="@_config.CustomArgs"
                                  ValueChanged="@(v => OnConfigChanged(() => _config.CustomArgs = v))"
                                  Placeholder="e.g. -nointro -prefetch" />
                </MudItem>
            </MudGrid>
        </div>

        @* ── Launch Button ── *@
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   Size="MudBlazor.Size.Large"
                   FullWidth="true"
                   Class="mb-6"
                   Style="font-size: 1.2rem; letter-spacing: 2px; padding: 16px;"
                   Disabled="@_launching"
                   OnClick="LaunchGame">
            @if (_launching)
            {
                <MudProgressCircular Size="MudBlazor.Size.Small" Indeterminate="true" Class="mr-2" />
                <span>LAUNCHING...</span>
            }
            else
            {
                <span>ENTER THE ZONE</span>
            }
        </MudButton>

        @* ── Maintenance ── *@
        <MudText Typo="Typo.h5" Class="mb-3" Style="color: var(--mud-palette-primary);">
            Maintenance
        </MudText>

        <MudPaper Class="pa-4 mb-4" Style="background-color: rgba(58, 58, 50, 0.6);" Elevation="0">
            <MudGrid Spacing="3">
                <MudItem xs="12" sm="6">
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Warning"
                               FullWidth="true"
                               Disabled="@_clearingCache"
                               OnClick="ClearShaderCache">
                        @if (_clearingCache)
                        {
                            <MudProgressCircular Size="MudBlazor.Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Clearing...</span>
                        }
                        else
                        {
                            <span>Clear Shader Cache</span>
                        }
                    </MudButton>
                    <MudText Typo="Typo.caption" Class="mt-1" Style="color: var(--mud-palette-text-secondary);">
                        Delete compiled shaders. They will be rebuilt on next launch.
                    </MudText>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Error"
                               FullWidth="true"
                               Disabled="@_resettingUserLtx"
                               OnClick="ResetUserLtx">
                        @if (_resettingUserLtx)
                        {
                            <MudProgressCircular Size="MudBlazor.Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Resetting...</span>
                        }
                        else
                        {
                            <span>Reset user.ltx</span>
                        }
                    </MudButton>
                    <MudText Typo="Typo.caption" Class="mt-1" Style="color: var(--mud-palette-text-secondary);">
                        Delete user.ltx to regenerate defaults on next launch.
                    </MudText>
                </MudItem>
            </MudGrid>
        </MudPaper>

        @* ── Game Paths Info ── *@
        @if (_paths != null)
        {
            <MudExpansionPanels Class="mb-4">
                <MudExpansionPanel Text="Game Paths" Style="background-color: rgba(58, 58, 50, 0.6);">
                    <MudSimpleTable Dense="true" Style="background-color: transparent;">
                        <tbody>
                            <tr>
                                <td><MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-secondary);">Game Root</MudText></td>
                                <td><MudText Typo="Typo.body2">@_paths.GameRoot</MudText></td>
                            </tr>
                            <tr>
                                <td><MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-secondary);">Appdata</MudText></td>
                                <td><MudText Typo="Typo.body2">@_paths.Appdata</MudText></td>
                            </tr>
                            <tr>
                                <td><MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-secondary);">Gamedata</MudText></td>
                                <td><MudText Typo="Typo.body2">@_paths.Gamedata</MudText></td>
                            </tr>
                            <tr>
                                <td><MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-secondary);">Bin</MudText></td>
                                <td><MudText Typo="Typo.body2">@_paths.Bin</MudText></td>
                            </tr>
                            <tr>
                                <td><MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-secondary);">Launcher Dir</MudText></td>
                                <td><MudText Typo="Typo.body2">@_paths.LauncherDir</MudText></td>
                            </tr>
                        </tbody>
                    </MudSimpleTable>
                </MudExpansionPanel>
            </MudExpansionPanels>
        }

    </MudContainer>
}

@code
{
    private LauncherConfig _config = new();
    private GamePaths? _paths;
    private bool _loading = true;
    private bool _launching;
    private bool _clearingCache;
    private bool _resettingUserLtx;
    private System.Timers.Timer? _saveDebounce;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _config = await Tauri.Core.Invoke<LauncherConfig>("get_launcher_config") ?? new();
            _paths = await Tauri.Core.Invoke<GamePaths>("get_game_paths");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load configuration: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void OnConfigChanged(Action applyChange)
    {
        applyChange();
        DebounceSave();
        StateHasChanged();
    }

    /// Debounce saves so rapid changes (e.g. typing in custom args) don't spam the backend.
    private void DebounceSave()
    {
        _saveDebounce?.Stop();
        _saveDebounce?.Dispose();
        _saveDebounce = new System.Timers.Timer(500);
        _saveDebounce.Elapsed += async (_, _) =>
        {
            _saveDebounce?.Stop();
            await SaveConfig();
        };
        _saveDebounce.AutoReset = false;
        _saveDebounce.Start();
    }

    private async Task SaveConfig()
    {
        try
        {
            await Tauri.Core.Invoke("save_launcher_config", new { config = _config });
        }
        catch (Exception ex)
        {
            await InvokeAsync(() =>
            {
                Snackbar.Add($"Failed to save config: {ex.Message}", Severity.Error);
                StateHasChanged();
            });
        }
    }

    private async Task LaunchGame()
    {
        _launching = true;
        try
        {
            await Tauri.Core.Invoke("launch_game");
            Snackbar.Add("Game launched", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to launch: {ex.Message}", Severity.Error);
        }
        finally
        {
            _launching = false;
        }
    }

    private async Task ClearShaderCache()
    {
        var confirmed = await ConfirmAction(
            "Clear Shader Cache",
            "This will delete the compiled shader cache. Shaders will be recompiled on next game launch, which may cause longer initial load times. Continue?");

        if (!confirmed) return;

        _clearingCache = true;
        try
        {
            var bytesFreed = await Tauri.Core.Invoke<long>("clear_shader_cache");
            var mb = bytesFreed / (1024.0 * 1024.0);
            Snackbar.Add($"Shader cache cleared ({mb:F1} MB freed)", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to clear shader cache: {ex.Message}", Severity.Error);
        }
        finally
        {
            _clearingCache = false;
        }
    }

    private async Task ResetUserLtx()
    {
        var confirmed = await ConfirmAction(
            "Reset user.ltx",
            "This will delete user.ltx. The game will regenerate it with default settings on next launch. All console command values will be reset. Continue?");

        if (!confirmed) return;

        _resettingUserLtx = true;
        try
        {
            await Tauri.Core.Invoke("reset_user_ltx");
            Snackbar.Add("user.ltx has been reset", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to reset user.ltx: {ex.Message}", Severity.Error);
        }
        finally
        {
            _resettingUserLtx = false;
        }
    }

    private async Task<bool> ConfirmAction(string title, string message)
    {
        var parameters = new DialogParameters<ConfirmDialog>
        {
            { x => x.ContentText, message },
            { x => x.ButtonText, "Confirm" },
            { x => x.Color, Color.Warning }
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>(title, parameters, options);
        var result = await dialog.Result;

        return result != null && !result.Canceled;
    }

    public void Dispose()
    {
        _saveDebounce?.Dispose();
    }
}
