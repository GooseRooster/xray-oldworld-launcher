@using XrayOldworldLauncher.Models.Options
@using XrayOldworldLauncher.Services

@inject OptionsStateService StateService
@inject LocalizationService Loc
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@implements IDisposable

<MudContainer MaxWidth="MaxWidth.Medium" Class="py-4" Style="background-color: transparent;">
      <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd" Class="mt-2 mb-4">
            <MudButton Variant="Variant.Outlined" Color="Color.Warning"
                       OnClick="ResetToDefaults" Disabled="@_busy"
                       StartIcon="@Icons.Material.Filled.RestartAlt"
                       Class="zone-button-outlined">
                @Loc.T("ui.reset_to_defaults")
            </MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                       OnClick="Save" Disabled="@(!StateService.HasPendingChanges || _busy)"
                       StartIcon="@Icons.Material.Filled.Save"
                       Class="zone-button-filled">
                @if (_saving)
                {
                    <MudProgressCircular Size="MudBlazor.Size.Small" Indeterminate="true" Class="mr-1" />
                    <span>@Loc.T("ui.saving")</span>
                }
                else
                {
                    <span>@Loc.T("ui.save")</span>
                }
            </MudButton>
        </MudStack>

        @foreach (var group in Page.Groups)
        {
            <OptionFormGroup Group="@group" PageId="@Page.Id" />
        }
</MudContainer>

@code {
    [CascadingParameter(Name = "Language")] public string? Language { get; set; }
    [Parameter] public OptionPage Page { get; set; } = null!;

    private bool _saving;
    private bool _resetting;
    private bool _busy => _saving || _resetting;

    protected override async Task OnInitializedAsync()
    {
        StateService.OnStateChanged += OnStateChanged;
    }

    private async Task Save()
    {
        _saving = true;
        try
        {
            await StateService.SaveAllAsync();
            Snackbar.Add(Loc.T("snackbar.options_saved"), Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(Loc.T("snackbar.options_save_failed"), ex.Message), Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task ResetToDefaults()
    {
        var pageName = Loc.T($"page.{Page.Id}");
        var parameters = new DialogParameters<ConfirmDialog>
        {
            { x => x.ContentText, string.Format(Loc.T("dialog.reset_options"), pageName) },
            { x => x.ButtonText, Loc.T("ui.reset") },
            { x => x.Color, Color.Warning }
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>(Loc.T("ui.reset_to_defaults"), parameters, options);
        var result = await dialog.Result;

        if (result == null || result.Canceled) return;

        _resetting = true;
        try
        {
            await StateService.ResetToDefaultsAsync(Page);
            Snackbar.Add(string.Format(Loc.T("snackbar.reset_success"), pageName), Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(Loc.T("snackbar.reset_failed"), ex.Message), Severity.Error);
        }
        finally
        {
            _resetting = false;
        }
    }

    private void OnStateChanged() => InvokeAsync(StateHasChanged);

    public void Dispose()
    {
        StateService.OnStateChanged -= OnStateChanged;
    }
}
