@using XrayOldworldLauncher.Models.Options
@using XrayOldworldLauncher.Services

@inject OptionsStateService StateService
@inject LocalizationService Loc
@implements IDisposable

<div class="zone-option-group pa-4 mb-3">
    <MudText Typo="Typo.h6" Class="worn-text mb-1" Style="letter-spacing: 1px;">@Loc.T($"group.{PageId}.{Group.Id}")</MudText>
    <div class="industrial-divider" style="margin-top: 0; margin-bottom: 12px;"></div>

    @foreach (var opt in Group.Options)
    {
        @if (IsOptionVisible(opt))
        {
            <OptionControl Definition="@opt"
                           Value="@StateService.GetCurrentValue(opt, PageId, Group.Id)"
                           ValueChanged="@(v => OnOptionChanged(opt, v))" />
        }
    }
</div>

@code {
    [CascadingParameter(Name = "Language")] public string? Language { get; set; }
    [Parameter] public OptionGroup Group { get; set; } = null!;
    [Parameter] public string PageId { get; set; } = "";

    protected override void OnInitialized()
    {
        StateService.OnStateChanged += OnStateChanged;
    }

    private bool IsOptionVisible(OptionDefinition opt)
    {
        if (opt.VisibleWhen == null) return true;
        return opt.VisibleWhen(StateService.GetEffectiveValues());
    }

    private void OnOptionChanged(OptionDefinition opt, string newValue)
    {
        StateService.SetPendingChange(opt, PageId, Group.Id, newValue);
        StateHasChanged();
    }

    private void OnStateChanged() => InvokeAsync(StateHasChanged);

    public void Dispose()
    {
        StateService.OnStateChanged -= OnStateChanged;
    }
}
