@using XrayOldworldLauncher.Services
@inject Tauri Tauri
@inject LocalizationService Loc
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@implements IDisposable

<div class="launch-panel pa-3">
    @if (_loading)
    {
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="200px" />
    }
    else
    {
        @* ── Configuration Controls ── *@
        <MudStack Spacing="3">
            <MudSwitch T="bool"
                       Label="@Loc.T("main.debug_mode")"
                       Color="Color.Warning"
                       Value="@_config.DebugMode"
                       ValueChanged="@(v => OnConfigChanged(() => _config.DebugMode = v))" />

            <MudSwitch T="bool"
                       Label="@Loc.T("main.use_avx")"
                       Color="Color.Primary"
                       Value="@_config.UseAvx"
                       ValueChanged="@(v => OnConfigChanged(() => _config.UseAvx = v))" />

            <MudSelect T="int"
                       Label="@Loc.T("main.shadow_map_size")"
                       Variant="Variant.Outlined"
                       Margin="Margin.Dense"
                       Value="@_config.ShadowMapSize"
                       ValueChanged="@(v => OnConfigChanged(() => _config.ShadowMapSize = v))">
                <MudSelectItem T="int" Value="1536">1536</MudSelectItem>
                <MudSelectItem T="int" Value="2048">2048 (@Loc.T("ui.default"))</MudSelectItem>
                <MudSelectItem T="int" Value="2560">2560</MudSelectItem>
                <MudSelectItem T="int" Value="3072">3072</MudSelectItem>
                <MudSelectItem T="int" Value="4096">4096</MudSelectItem>
            </MudSelect>

            <MudTextField T="string"
                          Label="@Loc.T("main.custom_args")"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Value="@_config.CustomArgs"
                          ValueChanged="@(v => OnConfigChanged(() => _config.CustomArgs = v))"
                          Placeholder="@Loc.T("main.custom_args.placeholder")" />
        </MudStack>

        @* ── Bottom: Clear buttons + Play ── *@
        <div class="launch-panel-actions mt-auto pt-4">
            <div class="d-flex gap-2" style="align-items: stretch;">
                <MudStack Spacing="2" Class="flex-grow-1">
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Warning"
                               FullWidth="true"
                               Class="zone-button-outlined"
                               Disabled="@_clearingCache"
                               OnClick="ClearShaderCache">
                        @if (_clearingCache)
                        {
                            <MudProgressCircular Size="MudBlazor.Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>@Loc.T("ui.clearing")</span>
                        }
                        else
                        {
                            <span>@Loc.T("main.clear_shader_cache")</span>
                        }
                    </MudButton>

                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Error"
                               FullWidth="true"
                               Class="zone-button-outlined"
                               Disabled="@_resettingUserLtx"
                               OnClick="ResetUserLtx">
                        @if (_resettingUserLtx)
                        {
                            <MudProgressCircular Size="MudBlazor.Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>@Loc.T("ui.resetting")</span>
                        }
                        else
                        {
                            <span>@Loc.T("main.reset_user_ltx")</span>
                        }
                    </MudButton>
                </MudStack>

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           Class="zone-button-launch launch-play-button"
                           Disabled="@_launching"
                           OnClick="LaunchGame">
                    @if (_launching)
                    {
                        <MudProgressCircular Size="MudBlazor.Size.Small" Indeterminate="true" />
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.PlayArrow" Size="MudBlazor.Size.Large" />
                    }
                </MudButton>
            </div>
        </div>
    }
</div>

@code
{
    [CascadingParameter(Name = "Language")] public string? Language { get; set; }

    private LauncherConfig _config = new();
    private GamePaths? _paths;
    private bool _loading = true;
    private bool _launching;
    private bool _clearingCache;
    private bool _resettingUserLtx;
    private System.Timers.Timer? _saveDebounce;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _config = await Tauri.Core.Invoke<LauncherConfig>("get_launcher_config") ?? new();
            _paths = await Tauri.Core.Invoke<GamePaths>("get_game_paths");
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(Loc.T("snackbar.config_load_failed"), ex.Message), Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void OnConfigChanged(Action applyChange)
    {
        applyChange();
        DebounceSave();
        StateHasChanged();
    }

    private void DebounceSave()
    {
        _saveDebounce?.Stop();
        _saveDebounce?.Dispose();
        _saveDebounce = new System.Timers.Timer(500);
        _saveDebounce.Elapsed += async (_, _) =>
        {
            _saveDebounce?.Stop();
            await SaveConfig();
        };
        _saveDebounce.AutoReset = false;
        _saveDebounce.Start();
    }

    private async Task SaveConfig()
    {
        try
        {
            await Tauri.Core.Invoke("save_launcher_config", new { config = _config });
        }
        catch (Exception ex)
        {
            await InvokeAsync(() =>
            {
                Snackbar.Add(string.Format(Loc.T("snackbar.config_save_failed"), ex.Message), Severity.Error);
                StateHasChanged();
            });
        }
    }

    private async Task LaunchGame()
    {
        _launching = true;
        try
        {
            await Tauri.Core.Invoke("launch_game");
            Snackbar.Add(Loc.T("snackbar.game_launched"), Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(Loc.T("snackbar.launch_failed"), ex.Message), Severity.Error);
        }
        finally
        {
            _launching = false;
        }
    }

    private async Task ClearShaderCache()
    {
        var confirmed = await ConfirmAction(
            Loc.T("main.clear_shader_cache"),
            Loc.T("dialog.clear_shader_cache"));

        if (!confirmed) return;

        _clearingCache = true;
        try
        {
            var bytesFreed = await Tauri.Core.Invoke<long>("clear_shader_cache");
            var mb = bytesFreed / (1024.0 * 1024.0);
            Snackbar.Add(string.Format(Loc.T("snackbar.shader_cache_cleared"), mb.ToString("F1")), Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(Loc.T("snackbar.shader_cache_failed"), ex.Message), Severity.Error);
        }
        finally
        {
            _clearingCache = false;
        }
    }

    private async Task ResetUserLtx()
    {
        var confirmed = await ConfirmAction(
            Loc.T("main.reset_user_ltx"),
            Loc.T("dialog.reset_user_ltx"));

        if (!confirmed) return;

        _resettingUserLtx = true;
        try
        {
            await Tauri.Core.Invoke("reset_user_ltx");
            Snackbar.Add(Loc.T("snackbar.user_ltx_reset"), Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(Loc.T("snackbar.user_ltx_failed"), ex.Message), Severity.Error);
        }
        finally
        {
            _resettingUserLtx = false;
        }
    }

    private async Task<bool> ConfirmAction(string title, string message)
    {
        var parameters = new DialogParameters<ConfirmDialog>
        {
            { x => x.ContentText, message },
            { x => x.ButtonText, Loc.T("ui.confirm") },
            { x => x.Color, Color.Warning }
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>(title, parameters, options);
        var result = await dialog.Result;

        return result != null && !result.Canceled;
    }

    public void Dispose()
    {
        _saveDebounce?.Dispose();
    }
}
